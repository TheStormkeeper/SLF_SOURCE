/*
 * Copyright (c) 2011-2012 Initials Video Games
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */ 

#import "OgmoLevelState.h"
#import "OgmoCutSceneState.h"
#import "OptionState.h"


@implementation OgmoCutSceneState

- (id) init
{
	if ((self = [super init])) {
		self.bgColor = 0xff35353d;
        recA = [[NSMutableString alloc] initWithString:@"0"];
        recB = [[NSMutableString alloc] initWithString:@"0"];
        recL = [[NSMutableString alloc] initWithString:@"0"];
        recR = [[NSMutableString alloc] initWithString:@"0"];
        recSwipe = [[NSMutableString alloc] initWithString:@"0"];
        recSwipeUp = [[NSMutableString alloc] initWithString:@"0"];


        
        
	}
	return self;
}



- (void) create
{        
    
//    FlxG.level=1001;

    recording=NO;
    
    
    
    
    
    
    [super create];
    
    [FlxG setMaxElapsed:0.0285];

    
    if (!recording){
        
        buttonAString=@"0000000000000000000000000000000000000000000000000000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        buttonBString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000001111111111100011111100000000000000000000000000011111000000000000000000000000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111000000000000000000000000111111111111111111100000000000000000000000000000001111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111000000000000000000000000000000000000000000000000000000000000000111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        buttonLString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111100000011110000000111111111111000000000000000000000000000000000000000000000000000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        buttonRString=@"0000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000111111111111111111100000000000000000000000000000001111111111111111111111111111111111111110000000000000000000111111111111100000000111111111111111111111111111111111111111111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111100000000000000001111111111000000000000000000000000000111111111111000000000000000000000000000111111111111111100011111111111111111111000000000000000000000000000000000000000000000111111111111111111111111111111111111000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        buttonSwipeString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        buttonSwipeUpString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

        
        
//        buttonAString=@"000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011100001110011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
//        buttonBString=@"00000000000000000000000000000000000000000000000000000000000000000000000011111110000000000001111000000000000000000000000000000000000000000000000000000000000011111111111111000000000000000000000000001111111111111111110000000000000000000000000000000000000000000000000000000001111111111000001111111000000000000000111100000000000000000000000000000000011100000000000000000000000000000000000000000000000000000000000000000000111111111111100000000000000000000000000000000000000000000000000000000000000000001111100000000000000111111111111111110000000000000000000000000111110000000000000011111111111111111110000000000000000000000000000000000000111111111110000000000000000000000000000000000011111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111110000000000001111111111110000000000000000000000000000000000000111111111111111111100000000000000000000000000000000001111000000000000000000000000000000000000011111110000000000000000000000000000001111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
//        buttonLString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111000000000000000000000000000111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
//        buttonRString=@"0000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000011111111111111111100000000000000000000000000000011111111111111111111111111111111111111000000011111111110000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000011111111111111110000000000000000000000000000000000001111111111111111111000000011110000000111111111111111111111111100000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000000000000000000000000000011111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
//        buttonSwipeString=@"0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
        
        
        frameNumber=0;
        
        buttonA.visible=NO;
        buttonB.visible=NO;
        buttonLeft.visible=NO;
        buttonRight.visible=NO;
        FlxG.touches.humanControlled=NO;
        pauseGraphic.visible=NO;
    }
    else if (recording) {


    }
    
    
    
}

- (void) dealloc
{
    [recA release];
    [recB release];
    [recL release];
    [recR release];    
    [recSwipe release];    
    [recSwipeUp release];  
    
    [super dealloc];
}



- (void) update
{       
    //NSLog(@"%d %d %d", [[buttonLString substringFromIndex:frameNumber]isEqualToString:@"1"], [[buttonRString substringFromIndex:frameNumber]isEqualToString:@"1"], frameNumber);
    
//    if (FlxG.touches.touchesBegan) {
//        NSLog(@"%d", frameNumber);
//    }
    
    //NSLog(@"max elapsed %f", FlxG.elapsed);
    
    
    //playback
    if (!recording) {
        NSString * newL = [buttonLString substringWithRange:NSMakeRange(frameNumber, 1)];
        NSString * newR = [buttonRString substringWithRange:NSMakeRange(frameNumber, 1)];
        NSString * newA = [buttonAString substringWithRange:NSMakeRange(frameNumber, 1)];
        NSString * newB = [buttonBString substringWithRange:NSMakeRange(frameNumber, 1)];
        NSString * newSwipe = [buttonSwipeString substringWithRange:NSMakeRange(frameNumber, 1)];
        NSString * newSwipeUp = [buttonSwipeUpString substringWithRange:NSMakeRange(frameNumber, 1)];
        
        //NSLog(@" %d %d", frameNumber, [buttonAString length]);
        
        if (frameNumber+3 > [buttonAString length]) {
            _levelFinished=YES;
        }

        
        FlxG.touches.newTouch=YES;
        if ([newA isEqualToString:@"1"]) {
            FlxG.touches.vcpButton1=YES;
        }
        else
        {
            FlxG.touches.vcpButton1=NO;
        }
        
        if ([newB isEqualToString:@"1"]) {
            FlxG.touches.vcpButton2=YES;
        }
        else
        {
            FlxG.touches.vcpButton2=NO;
        } 
        
        if ([newL isEqualToString:@"1"]) {
            FlxG.touches.vcpLeftArrow=YES;
        }
        else
        {
            FlxG.touches.vcpLeftArrow=NO;
        }
        
        if ([newR isEqualToString:@"1"]) {
            FlxG.touches.vcpRightArrow=YES;
        }
        else
        {
            FlxG.touches.vcpRightArrow=NO;
        } 
        
        if ([newSwipe isEqualToString:@"1"]) {
            FlxG.touches.swipedUp=YES;
            FlxG.touches.swipedDown=YES;
            NSLog(@"swipe %d ", FlxG.touches.swipedUp);
            
            [super switchCharacters];

        }
        else
        {
            FlxG.touches.swipedUp=NO;
            FlxG.touches.swipedDown=NO;
        }  
        if ([newSwipeUp isEqualToString:@"1"]) {
            if (!player.isPiggyBacking) {
                [FlxG playWithParam1:@"SndOnShoulders.caf" param2:0.35 param3:NO];
            }
            if (!player.isMale) {
                [self switchCharacters:YES flicker:1.5 withSound:NO];
            }
            liselot.isPiggyBacking=!liselot.isPiggyBacking;
            liselot.visible=!liselot.visible;
            player.isPiggyBacking=!player.isPiggyBacking;        }
        else
        {
        }      
        
        
        
        if (!paused)
            frameNumber++;

    }
    
    else if (recording) {
        if (FlxG.touches.vcpButton1) {
            [recA appendString:@"1"];            
        }
        else {
            [recA appendString:@"0"];
        }
        
        if (FlxG.touches.vcpButton2) {
            [recB appendString:@"1"];            
        }
        else {   
            [recB appendString:@"0"];            
        }
        if (FlxG.touches.vcpLeftArrow) {
            [recL appendString:@"1"];            
        }
        else {
            [recL appendString:@"0"];
        }
        
        if (FlxG.touches.vcpRightArrow) {
            [recR appendString:@"1"];            
        }
        else {   
            [recR appendString:@"0"];            
        }       
        
        if (FlxG.touches.swipedUp || FlxG.touches.swipedDown ) {
            [recSwipe appendString:@"1"];            
        }
        else {   
            [recSwipe appendString:@"0"];            
        }         
        if (FlxG.touches.swipedLeft || FlxG.touches.swipedRight) {
            [recSwipeUp appendString:@"1"];               
        }
        else {   
            [recSwipeUp appendString:@"0"];            
        } 
        
        
    }

    
        
    [super update];
    
    if (_levelFinished || FlxG.touches.touchesBegan ){ //|| FlxG.touches.touchesBegan
        
        if (recording) {
            NSLog(@"buttonAString=@\"%@\";\n", recA);
            NSLog(@"buttonBString=@\"%@\";\n", recB);
            NSLog(@"buttonLString=@\"%@\";\n", recL);
            NSLog(@"buttonRString=@\"%@\";\n", recR);
            NSLog(@"buttonSwipeString=@\"%@\";\n", recSwipe);
            NSLog(@"buttonSwipeUpString=@\"%@\";\n", recSwipeUp);

        }
        
        else if (!recording) {
            FlxG.level=1;
            //[FlxG playMusic:@"echo.mp3"];
            FlxG.state = [[[OptionState alloc] init] autorelease];
            return; 
        }
        
        
    }
}




@end

